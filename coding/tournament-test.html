<!DOCTYPE HTML>
<html>
	<head>
		<title>Tournament Sign-Up Form</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="/assets/css/main.css" />
		<script src="/assets/js/jquery.min.js"></script>
	</head>
	<style>
		.red {
			color: red;
		}
		form input[type="text"], form input[type="checkbox"], 
		form input[type="email"], form input[type="date"], form select {
			background: #ffffff;
		}
		form input[type="date"] {
			margin-left: 5px;
			border-width: 0;
			border-radius: 4px;
			line-height: 2.5;
			padding:0 10px;
			box-shadow: inset 2px 2px 0px 0px rgba(0, 0, 0, 0.1);
		}
		input[type="checkbox"]{
			display:none;
		}
		input[type="checkbox"] + label:before {
			border-radius: 4px;
			border: solid 1px #5b5252;
			background: #ffffff;
			border-color: #585858;
			color: #000000;
			content: '\2714';
			content: '\00a0';
			margin-right: 0.8em;
			margin-left: 0.5em;
			display: inline-block;
			font-size: 0.8em;
			height: 1.5em;
			line-height: 1.5em;
			left: 0;
			text-align: center;
			top: 0;
			width: 1.5em;
			-webkit-font-smoothing: antialiased;
			text-rendering: auto;
			text-transform: none !important;
			font-family: 'Font Awesome 5 Free';
			font-weight: 900;
		}
		.listMembers {
			display: none;
		}
		.listMembers > label {
			margin-top: 0.8em;
		}
		.compEvent {
			margin-bottom: 0;
		}
		input[type="checkbox"]:checked + label:before {
			content: '\2714';
		}
		.twoCell-1, .twoCell-2 {
			width: 48%; 
			display: inline-block
		}
		.twoCell-1 {
			padding-right: 1em;
		}
		.twoCell-2 {
			padding-left: 1em;
		}
		h5 {
			margin-bottom: 1em;
			text-align: center;
		}
		h6 {
			margin-top: 2em;
			margin-bottom: 0.5em; 
		}
		.auxParams {
			display:none;
		}
		.navButton {
			width: 100%;
			position: absolute;
			top: 95%;
		}
		.navButton button {
			font-size: 0.6em;
			background:#bbbbdd;
			border-color: #fff;
		}
		#formBox {
			width:40%;
			height:44em;
			margin:auto;
			overflow:hidden;
			background: #eeeeff;
			border-radius: 10px;
		}
        @media screen and (max-width: 700px) {
            #formBox {
                width: calc(100% - 40px);
                height:53em;
            }
        }
		.formGroup {
			width:90%;
			top: 5%;
			height: 90%;
			position: absolute;
			margin:auto;
			transition: all 1s
		}
		#participantInfo {
			left:5%;			
		}
		#eventInfo {
			left:100%;
		}
		.formHelp {
			width:50%;
			margin: auto;
			text-align: center;
			margin-bottom: 1em;
		}
		.formNote {
			font-size:0.8em;
			margin-left: 0;
			margin-top: -0.5em;
			margin-bottom: 1em;
			line-height: 1;
			color: #888;
		}
		button:disabled {
			pointer-events: none;
			opacity: 0.2
		}
	</style>
	<body class="homepage is-preload">
		<div id="page-wrapper">

			<!-- Header -->
				<section id="header">
					<div class="container">
						<!-- Menu -->
						<nav id="nav">
							<script>$("#nav").load("/menu.html")</script>
						</nav>

					</div>
					
				</section>

			<!-- Main -->
			<section id="main-ds">
				<div class="container">
					<div class="row">
						<!-- Content -->
							<div id="content" class="col-12">
								<!-- Post -->
									<article class="box post">	
										<h3>Tournament Sign-Up Form</h3>
										<form id="regForm" method="POST" action="https://script.google.com/macros/s/AKfycbznc_EELVi3PMhLXfLoXod-ofYeO9ObMARylwcIewUr5HdW841aVbtP4JCvrMYzjeY/exec">
										<div id="formBox" style="position:relative">	
											<div class="formGroup" id="participantInfo">
												<h5>Competitor Information</h5>
												<div class="twoCell-1">
													<label class="lead">First (given) name <sup class="red">*</sup>
														<input id="fname" name="fname" type="text" placeholder="First Name" required >
													</label>
												</div>
												<div class="twoCell-2">
													<label class="lead">Last (family) name <sup class="red">*</sup>
														<input id="lname" name="lname" type="text" placeholder="Last Name" required >
													</label>
												</div>
												<div style="text-align:center">
													<label class="lead">Birth date <sup class="red">*</sup> 
														<input id="birthday" name="birthday" type="date" placeholder="dd-mm-yyyy" required >
													</label>
												</div>
												<div class="twoCell-1">
													<label class="lead">Gender Division<sup class="red">*</sup>
														<select id="gender" name="gender" required>
															<option value="" disabled selected>Select...</option>
															<option value="F">Female</option>
															<option value="M">Male</option>
														</select>
													</label>
												</div>
												<div class="twoCell-2">
													<label class="lead">Rank <sup class="red">*</sup>
														<select id="rank" name="rank" required>
															<option value="" disabled selected>Select...</option>
															<option value="C10">10. Kyu</option>
															<option value="C9">9. Kyu</option>
															<option value="C8">8. Kyu</option>
															<option value="C7">7. Kyu</option>
															<option value="C6">6. Kyu </option>
															<option value="C5">5. Kyu</option>
															<option value="C4">4. Kyu</option>
															<option value="C3">3. Kyu</option>
															<option value="C2">2. Kyu</option>
															<option value="C1">1. Kyu</option>
															<option value="B1">1. Dan</option>
															<option value="B2">2. Dan</option>
															<option value="B3">3. Dan +</option>
														</select>
													</label>
												</div>
												<div class="formNote">
													<span>Note: if your gender identity is neither female or male, you should pick the gender division you prefer to compete in. Ranks and/or gender divisions may be combined depending on participation.</span>
												</div>
												
												<div class="oneCell">
													<label class="lead">E-Mail <sup class="red">*</sup> 
														<input id="email" name="email" type="email" placeholder="e.g. iLoveShotokan@karate.com" required >
													</label>
												</div>
												<div class="oneCell">
													<label class="lead">Club Name <sup class="red">*</sup> 
														<input id="clubName" name="clubName" type="text" placeholder="e.g. Shotokan Kyokai Berlin" required>
													</label>
												</div>
												<div class="oneCell">
													<label class="lead">Phone No. <sup class="red">*</sup>
														<input id="phone" name="phone" type="text" required>
													</label>
												</div>
												<div class="formNote">
													<span>For participants under 18, enter the parent or guardian's phone number.</span>
												</div>
												<div class="navButton" style="text-align: right;">
													<button type="button" onclick="goToEvents()">Select Events &rarr;</button>
												</div>
											</div>											
											<div class="formGroup" id="eventInfo">
												<h5>Events</h5>	
												<div class="formNote">
													<span>Select at least one event to compete in.</span>
												</div>
												<div id="indEvents" style="display:block">
													<h6>Individual Events</h6>
													<!-- Youth -->
													<input type="checkbox" class="youth-ind" name="youth-indKata" id="youth-indKata" value="x"><label for="youth-indKata" class="compEvent" >Kata</label>
													<input type="checkbox" class="youth-ind" name="youth-kihonKumite" id="youth-kihonKumite" value="x"><label for="youth-kihonKumite" class="compEvent" >Kihon Ippon Kumite</label>
													<input type="checkbox" class="youth-ind" name="youth-jiyuIppKumite" id="youth-jiyuIppKumite" value="x"><label for="youth-jiyuIppKumite" class="compEvent" >Jiyu Ippon Kumite</label>
													<input type="checkbox" class="youth-ind" name="youth-indKumite" id="youth-indKumite" value="x"><label for="youth-indKumite" class="compEvent" >Jiyu Kumite</label>
													<!-- Adult -->
													<input type="checkbox" class="adult-ind" name="adult-indKata" id="adult-indKata" value="x"><label for="adult-indKata" class="compEvent">Kata</label>
													<input type="checkbox" class="adult-ind" name="adult-kihonKumite" id="adult-kihonKumite" value="x"><label for="adult-kihonKumite" class="compEvent" >Kihon Ippon Kumite</label>
													<input type="checkbox" class="adult-ind" name="adult-jiyuIppKumite" id="adult-jiyuIppKumite" value="x"><label for="adult-jiyuIppKumite" class="compEvent" >Jiyu Ippon Kumite</label>
													<input type="checkbox" class="adult-ind" name="adult-indKumite" id="adult-indKumite" value="x"><label for="adult-indKumite" class="compEvent" >Jiyu Kumite</label>
												</div>
												<div id="teamEvents" style="display:block">
													<h6>Team Events</h6>
													<!-- Youth -->
													<input type="checkbox" class="youth-team" name="youth-teamKata" id="youth-teamKata" value="x"><label for="youth-teamKata" class="compEvent" >Team Kata</label>
													<div class="listMembers" id="youth-teamKataDiv">
														<label  >Fellow TEAM KATA members:
															<input id="youth-teamKataMembers" name="youth-teamKataMembers" type="text" placeholder="e.g. Max Mustermann, Erika Mustermann" >
														</label>
													</div>
													<input type="checkbox" class="youth-team" name="youth-teamKumite" id="youth-teamKu" value="x"><label for="youth-teamKumite" class="compEvent" >Team (Jiyu) Kumite</label>
													<div class="listMembers" id="youth-teamKumiteDiv">
														<label>Fellow TEAM KUMITE members:
															<input id="youth-teamKumiteMembers" name="youth-teamKumiteMembers" type="text" placeholder="e.g. Max Mustermann, Erika Mustermann" >
														</label>
													</div>
													<!-- Adult -->
													<input type="checkbox" class="adult-team" name="adult-teamKata" id="adult-teamKata" value="x"><label for="adult-teamKata" class="compEvent" >Team Kata</label>
													<div class="listMembers" id="adult-teamKataDiv">
														<label  >Fellow TEAM KATA members:
															<input id="adult-teamKataMembers" name="adult-teamKataMembers" type="text" placeholder="e.g. Max Mustermann, Erika Mustermann" >
														</label>
													</div>
													<input type="checkbox" class="adult-team" name="adult-teamKumite" id="adult-teamKumite" value="x"><label for="adult-teamKumite" class="compEvent" >Team (Jiyu) Kumite</label>
													<div class="listMembers" id="adult-teamKumiteDiv">
														<label>Fellow TEAM KUMITE members:
															<input id="adult-teamKumiteMembers" name="adult-teamKumiteMembers" type="text" placeholder="e.g. Max Mustermann, Erika Mustermann" >
														</label>
													</div>
												</div>
												<div class="navButton" style="text-align: left">
													<button type="button" onclick="goToParticipant()">&larr; Competitor Info</button>
												</div>
											</div>
											<div class="auxParams">
												<!-- hidden parameters -->
												<label class="lead">Age competing
													<input id="ageOnCompDay" name="ageOnCompDay" type="text" placeholder="--">
												</label>
												<label class="lead">Age Division
													<input id="ageDiv" name="ageDiv" type="text" placeholder="--">
												</label>
												<label class="lead">Number of Events
													<input id="total-events" name="total-events" type="number" value="0" placeholder="--">
												</label>
												<label class="lead">Fee
													<input id="total-fee" name="total-fee" type="number" value="0" placeholder="--">
												</label>
											</div>
										</div>	
										<div style="width: 50%; margin: auto; margin-top: 2em; text-align: right">
											<button id="submitButton">Submit</button>
										</div>
										</form>
										
											
										
										
									</article>
							</div>			
					</div>
				</div>
			</section>

			

			<!-- Footer -->
			<section id="footer">
				<script>$("#footer").load("/footer.html")</script>
			</section>

		</div>

		<!-- Scripts -->
			<script src="/assets/js/jquery.min.js"></script>
			<script src="/assets/js/jquery.dropotron.min.js"></script>
			<script src="/assets/js/browser.min.js"></script>
			<script src="/assets/js/breakpoints.min.js"></script>
			<script src="/assets/js/util.js"></script>
			<script src="/assets/js/main.js"></script>
			<script>
				// Updating events based on rank and age
				var ageOnCompDay = 0
				var ageDivision = ""
				var participantRank	= "" 
				var availableEvents = []
				var numberOfSelectedEvents = 0
				var nodeList = document.querySelectorAll(".youth-ind, .youth-team, .adult-ind, .adult-team")
				var nodesShown = []
				var submitButton = document.getElementById("submitButton")
				submitButton.disabled=true
				var teamEventIds = ["youth-teamKata","youth-teamKumite","adult-teamKata","adult-teamKumite" ]
				var mappingByRank = {
					"": [""],
					"C10": ["indKata", "teamKata", "kihonKumite"],
					"C9": ["indKata", "teamKata","kihonKumite"],
					"C8": ["indKata", "teamKata","kihonKumite"],
					"C7": ["indKata", "teamKata","kihonKumite"],
					"C6": ["indKata", "teamKata","kihonKumite"],
					"C5": ["indKata", "teamKata","kihonKumite", "jiyuIppKumite"],
					"C4": ["indKata", "teamKata","kihonKumite", "jiyuIppKumite"],
					"C3": ["indKata", "teamKata","jiyuIppKumite", "indKumite", "teamKumite"],
					"C2": ["indKata", "teamKata","jiyuIppKumite", "indKumite", "teamKumite"],
					"C1": ["indKata", "teamKata","jiyuIppKumite", "indKumite", "teamKumite"],
					"B1": ["indKata", "teamKata","indKumite", "teamKumite"],
					"B2": ["indKata", "teamKata","indKumite", "teamKumite"],
					"B3": ["indKata", "teamKata","indKumite", "teamKumite"]
				}

				// Calculating Participant Age
				function calculateAge(birthdate) { // birthday is a date
					// var birthdate = new Date(birthyear, birthmonth-1, birthday, 0,0,0,0)
					var tournamentDate = new Date(2024, 4, 1, 23, 59, 59, 999);
					var ageDifMs = tournamentDate - birthdate;
					var ageDate = new Date(ageDifMs)
					console.log(Math.abs(ageDate.getUTCFullYear() - 1970))
					return Math.abs(ageDate.getUTCFullYear() - 1970);
				 }

				function getAvailableEvents(rank, adiv){
					if (rank == "" || adiv == "" ){
						availableEvents = []
						return []
					} else {
						availableEvents = []
						let eventsList = mappingByRank[rank]
						eventsList.forEach(function(en){
							availableEvents.push(adiv+"-"+en)
						})
					return availableEvents
				 	}
				}

				function calcFee(en){
					if (en==0){return "0"}
					if (en==1){
						return "30"
					} else {
						return "45"
					}
				}

				 document.getElementById("rank").addEventListener("change", function(){
					participantRank = this.value
					getAvailableEvents(participantRank, ageDivision)
				 })

				 document.getElementById("birthday").addEventListener("change", function(){
					var bd = new Date(this.value)
					if (bd.getFullYear() >= 1800){
						// avoid unnecessary actions until date is fully typed
						ageOnCompDay = calculateAge(bd)
						console.log(ageOnCompDay)
						document.getElementById("ageOnCompDay").value = ageOnCompDay
						ageDivision = ageOnCompDay >= 18 ? "adult" : "youth"
						document.getElementById("ageDiv").value = ageDivision
						getAvailableEvents(participantRank, ageDivision)
					}
				 })

				
				// Actions when selecting or deselecting competition events 
				nodeList.forEach(function(node){
					document.querySelector("#"+node.id).addEventListener("change",function(m){
						if (this.checked){
							numberOfSelectedEvents += 1
							if (submitButton.disabled == true){
								submitButton.disabled = false
							}
						} else {
							numberOfSelectedEvents -= 1
							if (submitButton.disabled == false && numberOfSelectedEvents==0 ){
								submitButton.disabled = true
							}
						}
						console.log("no. selected: ", numberOfSelectedEvents)
						document.getElementById("total-events").value = numberOfSelectedEvents
						document.getElementById("total-fee").value = calcFee(numberOfSelectedEvents)
						if (teamEventIds.includes(node.id)){
							$("#"+node.id+"Div").toggle()
						}
					})
				})
			</script>
			<script>
				const participantFields = ["fname", "lname", "birthday", "gender", "rank", "email", "clubName", "phone"]
				participantFields.forEach(function(name){
						document.getElementById(name).addEventListener("change", function(){
							if (this.validity.valid){
								this.style["background"] = "#ffffff"
							}
						})})
				function participantValidity(){
					let validity = true
					participantFields.forEach(function(name){
						validity = document.getElementById(name).validity.valid
						if (validity===false){
							document.getElementById(name).style["background"] = "#ffcccc"
						}
					})
					return validity
				}
				function goToEvents(){
					let pI = document.querySelector("#participantInfo")
					let eI = document.querySelector("#eventInfo")
					let participantValid = participantValidity()
					if (participantValid==true){
						numberOfSelectedEvents = 0
						nodesShown = []
						nodeList.forEach(function(node){
							let label  = node.nextSibling
							availableEvents = getAvailableEvents(participantRank, ageDivision)
							if (availableEvents.includes(node.id)){
								nodesShown.push(node)
								label.style["display"] = "block"
								if (node.checked){
									numberOfSelectedEvents += 1
								}
							} else {
								node.checked = false
								label.style["display"] = "none"
								if (teamEventIds.includes(node.id)){
									$("#"+node.id+"Div").hide()
								}
							}
						})
						console.log("no. selected: ", numberOfSelectedEvents)
						document.getElementById("total-events").value = numberOfSelectedEvents
						document.getElementById("total-fee").value = calcFee(numberOfSelectedEvents)
						pI.style["left"] = "-100%"
						eI.style["left"] = "5%"
					}
				}
				function goToParticipant(){
					let pI = document.querySelector("#participantInfo")
					let eI = document.querySelector("#eventInfo")
					pI.style["left"] = "5%"
					eI.style["left"] = "100%"
				}
			</script>
			<script>
				// Redirecting user to success or error page when submitting the form
				window.addEventListener("load", function() {
					const form = document.getElementById('regForm');
					form.addEventListener('submit', (event) => {
						event.preventDefault();
						submitButton.innerHTML = "Processing..."
						submitButton.disabled = true
						fetch(form.action, {
							method: 'post',
							body: new FormData(form),
						}).then((res) => {
							if (!res.ok) {
							window.location.href = "tournamentsignup-error.html"
							}
							window.location.href = "tournamentsignup-submitted.html";
						});
					});
				});
			</script>
	</body>
</html>